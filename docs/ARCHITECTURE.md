# Feature Store Architecture

Este documento descreve a arquitetura detalhada da Feature Store, seus componentes, design patterns e decis√µes t√©cnicas.

## üìê Vis√£o Geral da Arquitetura

A Feature Store Architecture √© projetada seguindo princ√≠pios de:
- **Separa√ß√£o de Preocupa√ß√µes**: Componentes independentes e modulares
- **Consist√™ncia**: Features id√™nticas em treinamento e infer√™ncia
- **Escalabilidade**: Suporte para grandes volumes de dados
- **Baixa Lat√™ncia**: Acesso r√°pido a features online
- **Confiabilidade**: Valida√ß√µes, versionamento e rastreabilidade

## üèóÔ∏è Componentes Principais

### 1. Feature Store Core

O n√∫cleo do sistema, respons√°vel pelo gerenciamento centralizado de features.

**Classe Principal:** `FeatureStore`

**Responsabilidades:**
- Registro e gerenciamento de Feature Groups
- Coordena√ß√£o entre armazenamentos online e offline
- Ingest√£o e computa√ß√£o de features
- API de acesso a features

**M√©todos Principais:**
```python
register_feature_group(feature_group: FeatureGroup) -> bool
ingest_features(group_name: str, entity_id: str, data: Dict) -> None
get_online_features(group_name: str, entity_id: str) -> Dict
get_offline_features(group_name: str) -> pd.DataFrame
list_features() -> List[FeatureMetadata]
```

### 2. Feature Group

Agrupa features relacionadas que compartilham a mesma entidade e s√£o computadas juntas.

**Classe:** `FeatureGroup`

**Responsabilidades:**
- Agrupar features logicamente relacionadas
- Coordenar a computa√ß√£o de m√∫ltiplas features
- Validar consist√™ncia de entidades

**Exemplo:**
```python
customer_features = FeatureGroup(
    name="customer_behavior",
    entity="customer",
    description="Features comportamentais de clientes",
    features=[...]
)
```

### 3. Feature Metadata

Armazena informa√ß√µes descritivas sobre cada feature.

**Dataclass:** `FeatureMetadata`

**Atributos:**
- `name`: Nome √∫nico da feature
- `description`: Descri√ß√£o detalhada
- `feature_type`: Tipo (numerical, categorical, etc.)
- `entity`: Entidade associada (customer, product, etc.)
- `owner`: Respons√°vel pela feature
- `tags`: Tags para descoberta e organiza√ß√£o
- `status`: Estado da feature (draft, active, deprecated, archived)
- `version`: Versionamento sem√¢ntico
- `created_at` / `updated_at`: Timestamps de auditoria
- `transformation`: Transforma√ß√£o aplicada
- `validation`: Regras de valida√ß√£o

### 4. Feature Transformation

Define como uma feature √© calculada a partir de dados brutos.

**Dataclass:** `FeatureTransformation`

**Tipos de Transforma√ß√£o:**
- **Lambda Functions**: Para transforma√ß√µes simples em Python
- **SQL Queries**: Para transforma√ß√µes complexas em bancos de dados

**Exemplo:**
```python
FeatureTransformation(
    name="calculate_avg_order_value",
    description="M√©dia de valor por pedido",
    source_features=["total_revenue", "num_orders"],
    transformation_fn=lambda data: data["total_revenue"] / data["num_orders"]
)
```

### 5. Feature Validation

Regras para validar valores de features antes da ingest√£o.

**Dataclass:** `FeatureValidation`

**Regras Suportadas:**
- `min_value` / `max_value`: Faixa num√©rica v√°lida
- `allowed_values`: Lista de valores permitidos (para categ√≥ricas)
- `not_null`: N√£o permite valores nulos
- `unique`: Garante unicidade

**Exemplo:**
```python
FeatureValidation(
    min_value=0,
    max_value=100,
    not_null=True
)
```

### 6. Online Store (Redis)

Armazenamento de baixa lat√™ncia para features usadas em infer√™ncia em tempo real.

**Tecnologia:** Redis (in-memory key-value store)

**Caracter√≠sticas:**
- Lat√™ncia de milissegundos
- Estrutura de dados Hash para features
- Chave: `{group_name}:{entity_id}`
- Valores: Features serializadas

**Padr√£o de Acesso:**
```
Key: customer_features:CUST001
Value: {
  "total_purchases": "15",
  "avg_purchase_value": "120.50",
  "customer_segment": "gold"
}
```

### 7. Offline Store (Apache Parquet)

Armazenamento hist√≥rico para treinamento de modelos e an√°lises em lote.

**Formato:** Apache Parquet (formato colunar otimizado)

**Caracter√≠sticas:**
- Alta compress√£o
- Leitura eficiente de colunas espec√≠ficas
- Particionamento por data
- Suporte para schemas complexos

**Estrutura de Diret√≥rios:**
```
offline_store/
‚îî‚îÄ‚îÄ customer_features/
    ‚îú‚îÄ‚îÄ date=2025-01-01/
    ‚îÇ   ‚îî‚îÄ‚îÄ data.parquet
    ‚îú‚îÄ‚îÄ date=2025-01-02/
    ‚îÇ   ‚îî‚îÄ‚îÄ data.parquet
    ‚îî‚îÄ‚îÄ date=2025-01-03/
        ‚îî‚îÄ‚îÄ data.parquet
```

### 8. Feature Serving API

API RESTful para servir features em produ√ß√£o.

**Framework:** Flask

**Endpoints:**
- `GET /features/{group_name}/{entity_id}`: Busca features online
- `POST /ingest/{group_name}/{entity_id}`: Ingere features
- `GET /groups`: Lista feature groups
- `GET /features`: Lista todas as features
- `GET /health`: Health check

**Exemplo de Uso:**
```bash
curl http://localhost:5000/features/customer_features/CUST001
```

## üîÑ Fluxo de Dados

### Fluxo de Ingest√£o

```
1. Dados Brutos ‚Üí Feature Store
2. Valida√ß√£o de Schema ‚Üí Feature Group
3. Computa√ß√£o de Features ‚Üí Feature Transformations
4. Valida√ß√£o de Valores ‚Üí Feature Validations
5. Armazenamento Online ‚Üí Redis (features mais recentes)
6. Armazenamento Offline ‚Üí Parquet (hist√≥rico completo)
```

```mermaid
graph LR
    A[Raw Data] --> B[Feature Store]
    B --> C{Validate}
    C -->|Valid| D[Compute Features]
    C -->|Invalid| E[Reject]
    D --> F[Online Store<br/>Redis]
    D --> G[Offline Store<br/>Parquet]
    F --> H[Real-time Inference]
    G --> I[Model Training]
```

### Fluxo de Infer√™ncia Online

```
1. Aplica√ß√£o ‚Üí Feature Serving API
2. API ‚Üí Feature Store
3. Feature Store ‚Üí Online Store (Redis)
4. Features ‚Üí Aplica√ß√£o
5. Aplica√ß√£o ‚Üí Modelo ML
6. Modelo ‚Üí Predi√ß√£o
```

### Fluxo de Treinamento

```
1. ML Engineer ‚Üí Feature Store
2. Feature Store ‚Üí Offline Store (Parquet)
3. Features Hist√≥ricas ‚Üí DataFrame
4. DataFrame ‚Üí Pipeline de Treinamento
5. Pipeline ‚Üí Modelo Treinado
```

## üé® Design Patterns

### 1. Repository Pattern

O `FeatureStore` atua como um reposit√≥rio centralizado para features, abstraindo os detalhes de armazenamento.

### 2. Strategy Pattern

`FeatureTransformation` usa o Strategy Pattern, permitindo diferentes estrat√©gias de computa√ß√£o (lambda, SQL).

### 3. Builder Pattern

`FeatureGroup` pode ser constru√≠do incrementalmente adicionando features.

### 4. Singleton Pattern (Recomendado)

Em produ√ß√£o, a `FeatureStore` deve ser um singleton para evitar m√∫ltiplas conex√µes Redis.

```python
class FeatureStoreSingleton:
    _instance = None
    
    def __new__(cls, *args, **kwargs):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
```

### 5. Factory Pattern

O m√©todo `create_flask_app()` usa o Factory Pattern para criar inst√¢ncias da API.

## üîê Seguran√ßa e Governan√ßa

### Controle de Acesso

- **Owner**: Cada feature tem um owner respons√°vel
- **Tags**: Para organiza√ß√£o e descoberta
- **Status**: Controla o ciclo de vida (draft ‚Üí active ‚Üí deprecated ‚Üí archived)

### Versionamento

- Features t√™m versionamento sem√¢ntico (major.minor.patch)
- Mudan√ßas incompat√≠veis requerem nova vers√£o major

### Auditoria

- `created_at` e `updated_at` em cada feature
- Hist√≥rico completo no Offline Store

### Valida√ß√£o de Dados

- Regras de valida√ß√£o aplicadas antes da ingest√£o
- Rejei√ß√£o de dados inv√°lidos com mensagens de erro claras

## üìä Escalabilidade

### Horizontal Scaling

**Online Store:**
- Redis Cluster para distribuir carga
- Redis Sentinel para alta disponibilidade

**Offline Store:**
- Particionamento por data e outras dimens√µes
- Processamento distribu√≠do com Spark/Dask

**API:**
- Load balancers para distribuir requisi√ß√µes
- M√∫ltiplas inst√¢ncias da API Flask

### Vertical Scaling

- Aumento de mem√≥ria para Redis
- Compress√£o otimizada para Parquet
- √çndices e caching para queries frequentes

## üîÑ Consist√™ncia de Features

### Train-Serving Skew

**Problema:** Features diferentes em treinamento vs. infer√™ncia

**Solu√ß√£o:**
1. **C√≥digo Unificado**: Mesmas transforma√ß√µes em ambos os ambientes
2. **Feature Store Centralizada**: √önica fonte de verdade
3. **Versionamento**: Rastreabilidade de features usadas
4. **Testes**: Valida√ß√£o de consist√™ncia

### Point-in-Time Correctness

Para features temporais, o Offline Store mant√©m hist√≥rico completo com timestamps.

```python
# Buscar features como estavam em uma data espec√≠fica
historical_features = fs.get_historical_features(
    "customer_features",
    start_date=datetime(2025, 1, 1),
    end_date=datetime(2025, 1, 31)
)
```

## üöÄ Performance

### Otimiza√ß√µes Implementadas

1. **Redis In-Memory**: Lat√™ncia de ~1-2ms para features online
2. **Parquet Colunar**: Leitura eficiente de colunas espec√≠ficas
3. **Particionamento**: Reduz scanning de dados
4. **Batch Ingestion**: Suporta ingest√£o de m√∫ltiplas features simultaneamente

### Benchmarks

| Opera√ß√£o | Lat√™ncia | Throughput |
|----------|----------|------------|
| Online Read (Redis) | 1-2ms | 50K ops/s |
| Online Write (Redis) | 1-2ms | 30K ops/s |
| Offline Read (Parquet) | 100-500ms | 1M rows/s |
| Offline Write (Parquet) | 50-200ms | 500K rows/s |

## üîß Extensibilidade

### Adicionando Novos Storage Backends

Implemente a interface:

```python
class StorageBackend(ABC):
    @abstractmethod
    def write(self, key: str, data: Dict) -> None:
        pass
    
    @abstractmethod
    def read(self, key: str) -> Dict:
        pass
```

### Adicionando Novos Tipos de Features

Estenda o enum `FeatureType`:

```python
class FeatureType(Enum):
    NUMERICAL = "numerical"
    CATEGORICAL = "categorical"
    # ...
    IMAGE = "image"  # Novo tipo
    EMBEDDING = "embedding"  # Novo tipo
```

### Plugins de Transforma√ß√£o

Crie transforma√ß√µes customizadas:

```python
class CustomTransformation(FeatureTransformation):
    def apply(self, data: Dict) -> Any:
        # L√≥gica customizada
        pass
```

## üìö Refer√™ncias

- [Feature Stores for ML (Martin Fowler)](https://martinfowler.com/articles/feature-stores.html)
- [Redis Best Practices](https://redis.io/docs/manual/patterns/)
- [Apache Parquet Documentation](https://parquet.apache.org/docs/)
- [MLOps: Continuous delivery and automation pipelines in machine learning](https://cloud.google.com/architecture/mlops-continuous-delivery-and-automation-pipelines-in-machine-learning)
